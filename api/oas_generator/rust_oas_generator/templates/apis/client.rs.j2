#![allow(clippy::let_and_return)]

{% set client_type = get_client_type(spec) %}
/*
 * {{ spec.info.title }}
 *
 * {{ spec.info.description or "API client generated from OpenAPI specification" }}
 *
 * The version of the OpenAPI document: {{ spec.info.version }}
 {% if spec.info.contact and spec.info.contact.email %} * Contact: {{ spec.info.contact.email }}
 {% endif %} * Generated by: Rust OpenAPI Generator
 */

use super::Error;
use algokit_http_client::{DefaultHttpClient, HttpClient};
use std::sync::Arc;
{% if collect_parameter_enums(operations) %}
use super::parameter_enums::*;
{% endif %}
{% if operations %}
{% set used_types = [] %}
{% for operation in operations %}
    {% set operation_types = get_operation_used_types(operation) %}
    {% for type_name in operation_types %}
        {% if type_name not in used_types %}
            {% set _ = used_types.append(type_name) %}
        {% endif %}
    {% endfor %}
    {# Also collect request body types #}
    {% if has_request_body(operation) %}
        {% set request_body_type = get_request_body_type(operation) %}
        {% if request_body_type and should_import_request_body_type(request_body_type) and request_body_type not in used_types %}
            {% set _ = used_types.append(request_body_type) %}
        {% endif %}
    {% endif %}
{% endfor %}
{% if used_types %}
use crate::models::{
{% for used_type in used_types %}
    {{ used_type }},
{% endfor %}
};
{% endif %}
{% endif %}
{% if ffi %}
use algod_client::AlgodClient as RustAlgodClient;
{% endif %}

/// The main {{ client_type }} API client.
///
/// This client provides convenient access to all {{ client_type }} API endpoints.
/// It wraps the lower-level endpoint functions with a more ergonomic interface.
/// All methods return a unified `Error` type that can represent any endpoint error.
#[derive(Clone)]
{% if ffi %}
#[derive(uniffi::Object)]
{% endif %}
pub struct {{ client_type }}Client {
    {% if ffi %}
    inner_algod_client: Arc<RustAlgodClient>,
    {% else %}
    http_client: Arc<dyn HttpClient>,
    {% endif %}
}

{% if ffi %}
#[uniffi::export]
{% endif %}
impl {{ client_type }}Client {
    /// Create a new {{ client_type }}Client with a custom http client.
    {% if ffi %}#[uniffi::constructor]{% endif %}
    pub fn new(http_client: Arc<dyn HttpClient>) -> Self {
        {% if ffi %}
        let inner_algod_client = Arc::new(RustAlgodClient::new(http_client.clone()));
        Self { inner_algod_client }
        {% else %}
        Self { http_client }
        {% endif %}
    }

    {% if not ffi %}
    /// Create a new {{ client_type }}Client for Algorand TestNet.
    #[cfg(feature = "default_client")]
    pub fn testnet() -> Self {
        let http_client = Arc::new(DefaultHttpClient::new(
            {% if client_type == "Indexer" %}"https://testnet-idx.4160.nodely.dev"{% elif client_type == "Kmd" %}"http://localhost:7833"{% else %}"https://testnet-api.4160.nodely.dev"{% endif %}
        ));
        Self::new(http_client)
    }

    /// Create a new {{ client_type }}Client for Algorand MainNet.
    #[cfg(feature = "default_client")]
    pub fn mainnet() -> Self {
        let http_client = Arc::new(DefaultHttpClient::new(
            {% if client_type == "Indexer" %}"https://mainnet-idx.4160.nodely.dev"{% elif client_type == "Kmd" %}"http://localhost:7833"{% else %}"https://mainnet-api.4160.nodely.dev"{% endif %}
        ));
        Self::new(http_client)
    }

    /// Create a new {{ client_type }}Client for a local localnet environment.
    #[cfg(feature = "default_client")]
    pub fn localnet() -> Self {
        let http_client = Arc::new(DefaultHttpClient::with_header(
            {% if client_type == "Indexer" %}"http://localhost:8980"{% elif client_type == "Kmd" %}"http://localhost:4002"{% else %}"http://localhost:4001"{% endif %},
            {% if client_type == "Indexer" %}"X-Indexer-API-Token"{% elif client_type == "Kmd" %}"X-KMD-API-Token"{% else %}"X-Algo-API-Token"{% endif %},
            "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
        ).expect("Failed to create HTTP client with API token header"));
        Self::new(http_client)
    }
    {% endif %}
{% for operation in operations %}
    {% if operation.summary %}
    /// {{ operation.summary }}
    {% elif operation.description %}
    /// {{ operation.description | replace('\n', '\n    /// ') }}
    {% endif %}
    {% if operation.deprecated %}
    #[deprecated]
    {% endif %}
    pub async fn {{ operation.rust_function_name }}(
        &self,
    {% if has_request_body(operation) and operation.method.upper() not in ['GET', 'HEAD', 'DELETE'] %}
        {% set request_body_name = get_request_body_name(operation) %}
        {% set request_body_type = get_request_body_type(operation) %}
        {% if is_request_body_required(operation) %}{{ request_body_name }}: {{ request_body_type }},
        {% else %}{{ request_body_name }}: Option<{{ request_body_type }}>,
        {% endif %}
    {% endif %}
    {% for param in operation.parameters %}
        {% if param.is_enum_parameter %}
        {% if param.required %}{{ param.rust_name }}: {{ param.rust_enum_type }},
        {% else %}{{ param.rust_name }}: Option<{{ param.rust_enum_type }}>,
        {% endif %}
        {% else %}
        {% if param.required %}{{ param.rust_name }}: {% if param.rust_type == "String" %}&str{% else %}{{ param.rust_type }}{% endif %},
        {% else %}{{ param.rust_name }}: Option<{% if param.rust_type == "String" %}{% if ffi %}String{% else %}&str{% endif %}{% else %}{{ param.rust_type }}{% endif %}>,
        {% endif %}
        {% endif %}
    {% endfor %}
    ) -> Result<{% if get_success_response_type(operation) %}{% if get_success_response_type(operation) == "UnknownJsonValue"
    %}UnknownJsonValue{% else %}{{
    get_success_response_type(operation) }}{% endif %}{% else %}(){% endif %}, Error> {
        {% if not ffi %}
        super::{{ operation.rust_function_name }}::{{ operation.rust_function_name }}(
            self.http_client.as_ref(),
        {% if has_request_body(operation) and operation.method.upper() not in ['GET', 'HEAD', 'DELETE'] %}
            {{ get_request_body_name(operation) }},
        {% endif %}
        {% for param in operation.parameters %}
            {{ param.rust_name }},
        {% endfor %}
        ).await
        {% else %}
        self.inner_algod_client.{{ operation.rust_function_name }}(
        {% if has_request_body(operation) %}
            {% if is_request_body_required(operation) %}
            {% if operation.rust_function_name == "simulate_transaction" %}
            {{ get_request_body_name(operation) }}.try_into()?,
            {%else%}
            {{ get_request_body_name(operation) }}.into(),
            {% endif %}
            {% else %}
            {% if operation.rust_function_name == "teal_dryrun" %}
            {{ get_request_body_name(operation) }}.map(|v| v.try_into()).transpose()?,
            {%else%}
            {{ get_request_body_name(operation) }}.map(|v| v.into()),
            {% endif %}
            {% endif %}
        {% endif %}
        {% for param in operation.parameters %}
            {% if param.required %}
            {{ param.rust_name }}.into(),
            {% elif param.rust_type == "String" and not param.is_enum_parameter %}
            {{ param.rust_name }}.as_deref().map(|v| v.into()),
            {% else %}
            {{ param.rust_name }}.map(|v| v.into()),
            {% endif %}
        {% endfor %}
        ).await
        {% if get_success_response_type(operation) and "Vec<" in get_success_response_type(operation) %}
        .map(|v| v.into_iter()
            .map(|item| item.into())
            .collect())
        {% else %}
        .map(|v| v.into())
        {% endif %}
        .map_err(|e| e.into())
        {% endif %}
    }

{% endfor %}
}
