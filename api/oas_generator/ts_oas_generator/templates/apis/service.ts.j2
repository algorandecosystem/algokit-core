import type { BaseHttpRequest, ApiRequestOptions } from '../core/BaseHttpRequest';
// SignedTransaction codecs (only used when request/response types reference AlgokitSignedTransaction)
import { encodeSignedTransaction, encodeSignedTransactions } from '@algorandfoundation/algokit-transact';
{% if import_types and import_types|length > 0 %}
import type { {{ import_types | sort | join(', ') }} } from '../models/index';
{% endif %}

export class {{ service_class_name }} {
  constructor(public readonly httpRequest: BaseHttpRequest) {}

{% for op in operations %}
  {{ op.description | ts_doc_comment }}
  {{ op.operationId | ts_camel_case }}(
{%- for p in op.pathParameters %}
    {{ p.varName }}: {{ p.tsType }},
{%- endfor %}
{%- if op.otherParameters|length > 0 or op.requestBody %}
    params?: {
{%- for p in op.otherParameters %}
      {{ p.varName }}{% if not p.required %}?{% endif %}: {{ p.tsType }};
{%- endfor %}
{%- if op.requestBody %}
      body{% if not op.requestBody.required %}?{% endif %}: {{ op.requestBody.tsType }};
{%- endif %}
    },
{%- endif %}
    requestOptions?: ApiRequestOptions
  ): Promise<{{ op.responseTsType }}> {
    const headers: Record<string, string> = {};
{%   if op.returnsMsgpack %}
    // Content negotiation (aligned with Rust behavior):
    // - Default to msgpack when available (better performance, smaller payload)
    // - Only use JSON if explicitly requested via format=json
{%     if op.hasFormatParam and op.formatVarName %}
    const useJson = params?.{{ op.formatVarName }} === 'json';
    headers['Accept'] = useJson ? 'application/json' : 'application/msgpack';
{%     else %}
    // Prefer msgpack when available, fallback to JSON
    headers['Accept'] = 'application/msgpack';
{%     endif %}
{%   else %}
    headers['Accept'] = 'application/json';
{%   endif %}
{%   if op.requestBody %}
{%     if op.requestBody.supportsMsgpack and op.requestBody.supportsJson and op.hasFormatParam and op.formatVarName %}
    headers['Content-Type'] = params?.{{ op.formatVarName }} === 'json' ? 'application/json' : 'application/msgpack';
{%     elif op.requestBody.supportsMsgpack and not op.requestBody.supportsJson %}
    headers['Content-Type'] = 'application/msgpack';
{%     elif op.requestBody.supportsMsgpack and op.requestBody.supportsJson %}
    headers['Content-Type'] = 'application/msgpack';
{%     elif op.requestBody.mediaType %}
    headers['Content-Type'] = '{{ op.requestBody.mediaType }}';
{%     endif %}
{%   endif %}

    // Header parameters
{%   for p in op.otherParameters if p['in'] == 'header' %}
    if (params?.{{ p.varName }} !== undefined) {
      headers['{{ p.name }}'] = String(params.{{ p.varName }});
    }
{%   endfor %}

    return this.httpRequest.request({
      method: '{{ op.method }}',
      url: '{{ op.path }}',
      path: {
{%- for p in op.pathParameters %}
        '{{ p.name }}': {% if p['stringifyBigInt'] %}(typeof {{ p.varName }} === 'bigint' ? {{ p.varName }}.toString() : {{ p.varName }}){% else %}{{ p.varName }}{% endif %},
{%- endfor %}
      },
      query: {
{%- for p in op.otherParameters if p['in'] == 'query' %}
        '{{ p.name }}': {% if p['stringifyBigInt'] %}(typeof params?.{{ p.varName }} === 'bigint' ? (params!.{{ p.varName }} as bigint).toString() : params?.{{ p.varName }}){% else %}params?.{{ p.varName }}{% endif %},
{%- endfor %}
      },
      headers,
      body: {% if op.requestBody %}
        {% if op.requestBody.tsType == 'AlgokitSignedTransaction' %}
          params?.body ? encodeSignedTransaction(params!.body as any) : undefined
        {% elif op.requestBody.tsType == 'AlgokitSignedTransaction[]' %}
          params?.body ? encodeSignedTransactions(params!.body as any) : undefined
        {% else %}
          params?.body
        {% endif %}
      {% else %}undefined{% endif %},
{%   if op.requestBody %}
{%     if op.requestBody.supportsMsgpack and op.requestBody.supportsJson and op.hasFormatParam and op.formatVarName %}
      // Dynamic mediaType based on format parameter (prefer msgpack by default)
      mediaType: params?.{{ op.formatVarName }} === 'json' ? 'application/json' : 'application/msgpack',
{%     elif op.requestBody.supportsMsgpack and not op.requestBody.supportsJson %}
      // Only msgpack supported for request body
      mediaType: 'application/msgpack',
{%     elif op.requestBody.supportsMsgpack and op.requestBody.supportsJson %}
      // Both supported, prefer msgpack for better performance
      mediaType: 'application/msgpack',
{%     else %}
      mediaType: '{{ op.requestBody.mediaType }}',
{%     endif %}
{%   else %}
      mediaType: undefined,
{%   endif %}
      ...(requestOptions ?? {}),
      {% if op.requestBody %}bodyModelKey: {% if op.requestBody.tsType.endswith('[]') %}'{{ op.requestBody.tsType[:-2] }}'{% else %}'{{ op.requestBody.tsType }}'{% endif %},{% endif %}
      responseModelKey: '{{ op.responseTsType }}',
    });
  }

{% endfor %}
}
