name: API OAS Generator CI
# This workflow tests the OpenAPI Specification (OAS) generator in the api/ folder.
# It validates the Python-based Jinja2 generator, ensures generated Rust code compiles,
# and checks for output stability. Both algod and indexer clients are tested in parallel.

on:
  push:
    branches:
      - main
    paths:
      - "api/**"
      - "tools/api_tools/**"
      - "crates/algod_client/**"
      - "crates/indexer_client/**"
      - "packages/typescript/**"
      - ".github/workflows/api_ci.yml"
  pull_request:
    branches:
      - main
    paths:
      - "api/**"
      - "tools/api_tools/**"
      - "crates/algod_client/**"
      - "crates/indexer_client/**"
      - "packages/typescript/**"
      - ".github/workflows/api_ci.yml"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  oas_lint_and_test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-api-tools

      - name: Run OAS generator linting
        run: cargo api lint-oas

      - name: Run OAS generator tests
        run: cargo api test-oas

  api_client_generation:
    runs-on: ubuntu-latest
    needs: oas_lint_and_test
    strategy:
      matrix:
        client: [algod, indexer]
        include:
          - client: algod
            output_dir: crates/algod_client
          - client: indexer
            output_dir: crates/indexer_client
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-api-tools

      - name: Generate ${{ matrix.client }} API client
        run: cargo api generate-${{ matrix.client }}

      - name: Check for output stability
        run: |
          git add -N ${{ matrix.output_dir }}
          if ! git diff --exit-code --minimal ${{ matrix.output_dir }}; then
            echo "‚ùå Generated ${{ matrix.client }} client differs from committed version!"
            echo "üîß To fix: Run 'cargo api generate-${{ matrix.client }}' locally and commit the changes"
            exit 1
          fi

      - name: Verify generated code compiles
        run: cargo check --manifest-path Cargo.toml -p ${{ matrix.client }}_client

  ts_api_client_generation:
    runs-on: ubuntu-latest
    needs: oas_lint_and_test
    strategy:
      matrix:
        pkg: [algod_client, indexer_client]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-api-tools
        with:
          setup_algokit: 'true'
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Generate TypeScript API clients
        run: cargo api generate-ts-all

      - name: Check output stability for ${{ matrix.pkg }}
        run: |
          git add -N packages/typescript/${{ matrix.pkg }}
          if ! git diff --exit-code --minimal packages/typescript/${{ matrix.pkg }}; then
            echo "‚ùå Generated ${{ matrix.pkg }} TS client differs from committed version!"
            echo "üîß To fix: Run 'cargo api generate-ts-all' locally and commit the changes"
            exit 1
          fi

      - name: Install dependencies (${{ matrix.pkg }})
        working-directory: packages/typescript/${{ matrix.pkg }}
        run: bun install

      - name: Format check (${{ matrix.pkg }})
        working-directory: packages/typescript/${{ matrix.pkg }}
        run: npx prettier --check .

      - name: Build (tsc) ${{ matrix.pkg }}
        working-directory: packages/typescript/${{ matrix.pkg }}
        run: bun run build

      - name: Test (${{ matrix.pkg }})
        working-directory: packages/typescript/${{ matrix.pkg }}
        run: bun test
